<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yetkili Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===================== GENEL ===================== */
body {
  margin:0;
  font-family:'Roboto',sans-serif;
  background:#1f2a38;
  color:#e0e0e0;
  min-height:100vh;
  padding:20px;
  display:flex;
  justify-content:center;
  overflow-x:hidden; /* yatay kaydırmayı engelle */
}
.panel-wrapper {
  max-width:1200px;
  width:100%;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap:20px;
  justify-items:center;
}

/* ===================== PANEL ===================== */
.panel {
  background: linear-gradient(145deg,#1f2a38,#263248);
  border-radius:20px;
  padding:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.6);
}
.panel h2 {
  margin-top:0;
  margin-bottom:15px;
  color:#ffcc00;
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding-bottom:5px;
}

/* ===================== FORM ===================== */
input, textarea, select {
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.2);
  background:#1a2b3a;
  color:#fff;
  font-size:1rem;
  box-shadow:0 3px 6px rgba(0,0,0,0.4);
  transition:0.3s;
  outline:none;
}
input:focus, textarea:focus, select:focus {border-color:#ffcc00; box-shadow:0 0 8px #ffcc00;}
::placeholder {color: rgba(255,255,255,0.6);}
textarea {resize:vertical; min-height:120px; box-shadow:0 3px 6px rgba(0,0,0,0.4);}
select {appearance:none; -webkit-appearance:none; -moz-appearance:none; background-image:url('data:image/svg+xml;utf8,<svg fill="white" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat:no-repeat; background-position:right 12px center; background-size:16px 16px;}

/* ===================== BUTON ===================== */
button {
  border-radius:12px;
  padding:6px 10px;
  font-size:0.8rem;
  font-weight:600;
  cursor:pointer;
  border:none;
  transition:0.3s;
  box-shadow:0 3px 6px rgba(0,0,0,0.3);
}
#createUserBtn {background:linear-gradient(45deg,#27ae60,#2ecc71); color:#fff;}
.delete {background:linear-gradient(45deg,#e74c3c,#ff6b6b); color:#fff;}
.edit {background:linear-gradient(45deg,#9b59b6,#8e44ad); color:#fff;}
#sendMsgBtn {background:linear-gradient(45deg,#2980b9,#3498db); color:#fff;}
button:hover {transform:translateY(-2px); opacity:0.9; box-shadow:0 6px 12px rgba(0,0,0,0.4);}

/* ===================== HEADER ===================== */
header {
  grid-column: span 2;
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
header h1 {color:#ffcc00; margin:0; font-size:1.8rem;}
header div {display:flex; flex-wrap:wrap; gap:6px;}
header button {flex:1 1 auto; margin:3px 0;}

/* ===================== PROFİL SİMGESİ ===================== */
#profileBtn {
  width:40px;
  height:40px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#2980b9;
  border:none;
}

/* ===================== TABLO (CARD GÖRÜNÜM) ===================== */
#usersTable {width:100%;}
#usersTable tr {
  display:flex;
  flex-direction:column;
  background:linear-gradient(145deg,#263248,#1f2a38);
  margin-bottom:10px;
  padding:10px;
  border-radius:12px;
  box-shadow:0 4px 8px rgba(0,0,0,0.3);
}
#usersTable td {
  display:flex;
  justify-content:space-between;
  padding:5px 0;
  border-bottom:none;
  color:#e0e0e0;
}
#usersTable td:last-child {justify-content:flex-end;}
#usersTable th {display:none;}

/* ===================== MODAL ===================== */
.modal {display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; padding:10px; overflow-y:auto;}
.modal-content {background:#1f2a38; padding:20px; border-radius:12px; width:100%; max-width:400px; display:flex; flex-direction:column; gap:10px;}
.modal-content input, .modal-content textarea {margin:0;}

/* ===================== PROGRESS ===================== */
.progress-container {width:100%; background:#1a2b3a; border-radius:12px; height:25px; margin-top:10px; overflow:hidden;}
.progress-bar {height:100%; width:0%; background:#27ae60; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; font-size:0.85rem;}
.password-info {margin-top:5px; color:#ffcc00; font-size:0.85rem;}
#totalUsers {margin-bottom:10px; font-weight:bold; color:#ffcc00;}

/* ===================== MOBİL ===================== */
@media(max-width:1024px){
  .panel-wrapper{grid-template-columns:1fr;}
  header{flex-direction:column;align-items:flex-start;gap:10px;}
  #searchInput{width:100%;margin-bottom:8px;}
  #searchBtn{width:100%;}
  header button{width:100%;margin:3px 0;}
  table, th, td{font-size:0.85rem;}
}
@media(max-width:480px){
  body{padding:10px;}
  .panel{padding:15px;}
  header h1{font-size:1.5rem;}
  input, select, textarea, button{font-size:0.9rem; padding:8px;}
  .modal-content{width:95%; padding:15px;}
  th, td{padding:8px;}
  .progress-bar{font-size:0.75rem;}
}
</style>
</head>
<body>

<div class="panel-wrapper">
<header>
  <h1>Yetkili Paneli</h1>
  <div>
    <button id="profileBtn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="#fff" width="24" height="24" viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.4c-3.3 0-9.9 1.7-9.9 5v2.5h19.8v-2.5c0-3.3-6.6-5-9.9-5z"/></svg>
    </button>
    <button id="olayBtn">Olay Bildirimleri</button>
    <button id="patrolBtn">Devriye Takip</button>
    <button id="watchBtn" onclick="window.location.href='tamam.html'">Nöbet Takip</button>
    <button id="logoutBtn">Çıkış</button>
  </div>
</header>

<!-- Yeni Kullanıcı Oluştur Paneli -->
<div class="panel">
<h2>Yeni Kullanıcı Oluştur</h2>
<select id="newType">
  <option value="resident">Site Sakini</option>
  <option value="security">Güvenlik</option>
</select>

<div id="residentFields">
  <select id="newBlock"></select>
  <input type="text" id="newApartment" placeholder="Daire Numarası">
</div>

<div id="securityFields" style="display:none;">
  <input type="text" id="newFullName" placeholder="Ad Soyad">
  <input type="text" id="newPhone" placeholder="Telefon Numarası">
</div>

<input type="password" id="newPassword" placeholder="Şifre" readonly>
<div class="password-info" id="passwordInfo"></div>
<button id="createUserBtn">Oluştur</button>
<div id="createMsg"></div>
</div>

<!-- Mesaj Gönder Paneli -->
<div class="panel">
<h2>Mesaj Gönder</h2>
<label for="msgType">Mesaj Gönderilecek Tip</label>
<select id="msgType">
  <option value="resident">Site Sakini</option>
  <option value="security">Güvenlik</option>
</select>

<label for="msgSubject">Konu</label>
<input type="text" id="msgSubject" placeholder="Mesaj konusu...">

<label for="msgContent">Mesaj</label>
<textarea id="msgContent" rows="4" placeholder="Mesajınızı buraya yazın..."></textarea>

<button id="sendMsgBtn" style="background:#2980b9; color:#fff;">Gönder</button>
<div class="progress-container">
  <div class="progress-bar" id="progressBar">0/0</div>
</div>
<div id="msgStatus" style="margin-top:5px; color:#ffcc00;"></div>
</div>

<!-- Kullanıcı Tablosu Paneli -->
<div class="panel" style="grid-column: span 2;">
<h2>Kullanıcılar</h2>
<div id="totalUsers"></div>
<div>
<input type="text" id="searchInput" placeholder="Ara...">
<button id="searchBtn">Ara</button>
</div>
<table>
<thead>
<tr><th>Daire / Ad Soyad</th><th>Blok / Telefon</th><th>Tip</th><th>Şifre</th><th>İşlem</th></tr>
</thead>
<tbody id="usersTable"></tbody>
</table>
<div class="pagination" id="pagination"></div>
</div>

<!-- Modallar: Düzenleme ve Profil -->
<div id="editModal" class="modal">
<div class="modal-content">
<h3>Düzenle</h3>
<div id="editResidentFields">
<label>Daire Numarası</label>
<input type="text" id="editApartment" disabled>
</div>
<div id="editSecurityFields" style="display:none;">
<label>Ad Soyad</label>
<input type="text" id="editFullName" disabled>
<label>Telefon</label>
<input type="text" id="editPhone">
</div>
<label>Şifre</label>
<input type="text" id="editPassword">
<button id="saveEditBtn">Kaydet</button>
<button id="closeEditBtn">Kapat</button>
</div>
</div>

<div id="profileModal" class="modal">
<div class="modal-content">
<h3>Profil</h3>
<label>Kullanıcı Adı</label>
<input type="text" id="profileUsername" disabled>
<label>Eski Şifre</label>
<input type="password" id="oldProfilePassword" placeholder="Eski şifre">
<label>Yeni Şifre</label>
<input type="password" id="profilePassword" placeholder="Yeni şifre">
<button id="saveProfileBtn">Güncelle</button>
<button id="closeProfileBtn" style="background:#c0392b;">Kapat</button>
</div>
</div>

<!-- JS kısmı tamamen korunmuş şekilde -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const maxMsgsPerUser = 5;

const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=="admin"){ alert("Yetkisiz erişim!"); window.location.href="index.html"; }

document.getElementById('logoutBtn').addEventListener('click', ()=>{ sessionStorage.removeItem('currentUser'); window.location.href='index.html'; });
document.getElementById('patrolBtn').addEventListener('click', ()=>{ window.location.href = 'takip.html'; });
document.getElementById('olayBtn').addEventListener('click', () => { window.location.href = 'olaylar.html'; });

const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('profileModal');
const profileUsername = document.getElementById('profileUsername');
const oldProfilePassword = document.getElementById('oldProfilePassword');
const profilePassword = document.getElementById('profilePassword');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const closeProfileBtn = document.getElementById('closeProfileBtn');

profileBtn.addEventListener('click', ()=>{ profileUsername.value=currentUser.username; oldProfilePassword.value=""; profilePassword.value=""; profileModal.style.display="flex"; });
closeProfileBtn.addEventListener('click', ()=>profileModal.style.display="none");
saveProfileBtn.addEventListener('click', async ()=>{ 
  const oldPass = oldProfilePassword.value.trim();
  const newPass = profilePassword.value.trim();
  if(!oldPass||!newPass){ alert("Alanlar boş olamaz!"); return; }
  const snapshot = await get(ref(db,'users/'+currentUser.username));
  if(snapshot.exists() && snapshot.val().password === oldPass){
    await update(ref(db,'users/'+currentUser.username), {password:newPass});
    alert("Şifre güncellendi!");
    profileModal.style.display="none";
  } else { alert("Eski şifre yanlış!"); }
});

// Form alanları ve şifre otomatik
const newType = document.getElementById('newType');
const residentFields = document.getElementById('residentFields');
const securityFields = document.getElementById('securityFields');
const newPassword = document.getElementById('newPassword');
const passwordInfo = document.getElementById('passwordInfo');

for(let c=65;c<=90;c++){document.getElementById('newBlock').innerHTML += `<option value="${String.fromCharCode(c)}">${String.fromCharCode(c)}</option>`;}

function updatePasswordField(){
  if(newType.value==='resident'){
    const block = document.getElementById('newBlock').value;
    const apartment = document.getElementById('newApartment').value.trim();
    const pwd = block && apartment ? (block+apartment) : '';
    newPassword.value = pwd;
    passwordInfo.textContent = pwd ? `Şifre otomatik atandı Şifreniz => ${pwd} <= Bu şifreyi profilinizden değiştirebilirsiniz` : '';
  } else {
    const fullName = document.getElementById('newFullName').value.trim().toUpperCase();
    const pwd = fullName;
    newPassword.value = pwd;
    passwordInfo.textContent = pwd ? `Şifre otomatik atandı Şifreniz => ${pwd} <= Bu şifreyi profilinizden değiştirebilirsiniz` : '';
  }
}

newType.addEventListener('change', ()=>{ 
  if(newType.value==='resident'){ residentFields.style.display='block'; securityFields.style.display='none'; } 
  else { residentFields.style.display='none'; securityFields.style.display='block'; } 
  updatePasswordField(); 
});

document.getElementById('newBlock').addEventListener('input', updatePasswordField);
document.getElementById('newApartment').addEventListener('input', updatePasswordField);
document.getElementById('newFullName').addEventListener('input', e=>{ e.target.value=e.target.value.toUpperCase(); updatePasswordField(); });

// Kullanıcı listeleme
const usersTable = document.getElementById('usersTable');
const paginationDiv = document.getElementById('pagination');
const totalUsersDiv = document.getElementById('totalUsers');
let allUsers = {};
let filteredUsers = [];
let currentPage = 1;
const pageSize = 20;

function listUsers(){
  const usersRef = ref(db,'users');
  onValue(usersRef, snapshot=>{
    allUsers = snapshot.val() || {};
    applyFilter();
  });
}

function applyFilter(){
  const searchVal = document.getElementById('searchInput').value.toLowerCase();
  filteredUsers = Object.values(allUsers).filter(u=>{
    if(u.type!=='resident' && u.type!=='security') return false;
    if(searchVal==='') return true;
    if(u.type==='resident'){ return (u.block+u.username).toLowerCase().includes(searchVal); } 
    else { return (u.fullName && u.fullName.toLowerCase().includes(searchVal)) || (u.phone && u.phone.includes(searchVal)); }
  });
  currentPage = 1;
  renderTable();
}

function renderTable(){
  usersTable.innerHTML='';
  totalUsersDiv.textContent = `Toplam Kullanıcı: ${filteredUsers.length}`;
  const start = (currentPage-1)*pageSize;
  const end = start + pageSize;
  filteredUsers.slice(start,end).forEach(u=>{
    const tr = document.createElement('tr');
    const nameCol = u.type==='resident' ? u.username : u.fullName;
    const blockCol = u.type==='resident' ? u.block : u.phone;
    const typeCol = u.type==='resident' ? "Site Sakini" : "Güvenlik";
    tr.innerHTML = `<td>${nameCol}</td><td>${blockCol}</td><td>${typeCol}</td><td>${u.password}</td>
                    <td><button class="edit" data-username="${u.username}">Düzenle</button>
                    <button class="delete" data-username="${u.username}">Sil</button></td>`;
    usersTable.appendChild(tr);
  });
  renderPagination();
  attachRowEvents();
}

function renderPagination(){
  paginationDiv.innerHTML='';
  const totalPages = Math.ceil(filteredUsers.length/pageSize);
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.className='page-btn'+(i===currentPage?' active':'');
    btn.textContent=i;
    btn.onclick=()=>{ currentPage=i; renderTable(); };
    paginationDiv.appendChild(btn);
  }
}

document.getElementById('searchBtn').addEventListener('click', applyFilter);
document.getElementById('searchInput').addEventListener('keyup', e=>{ if(e.key==='Enter') applyFilter(); });

// Yeni kullanıcı oluştur
document.getElementById('createUserBtn').addEventListener('click', async ()=>{
  const type = newType.value;
  let username, phone, block, apartment, fullName;
  if(type==='resident'){ block=document.getElementById('newBlock').value; apartment=document.getElementById('newApartment').value.trim(); if(!block||!apartment){alert('Daire ve blok gerekli!'); return;} username=block+apartment; } 
  else { fullName=document.getElementById('newFullName').value.trim().toUpperCase(); phone=document.getElementById('newPhone').value.trim(); if(!fullName||!phone){alert('İsim ve telefon gerekli!'); return;} username=fullName; }
  const pwd=newPassword.value;
  await set(ref(db,'users/'+username),{type,username,password:pwd,phone:phone||'',block:block||'',apartment:apartment||'',fullName:fullName||''});
  alert("Kullanıcı oluşturuldu!");
  location.reload();
});

// Düzenle ve silme işlemleri
function attachRowEvents(){
  document.querySelectorAll('.delete').forEach(btn=>{ btn.onclick = async ()=>{ if(confirm("Silmek istediğinize emin misiniz?")){ await remove(ref(db,'users/'+btn.dataset.username)); } }; });
  document.querySelectorAll('.edit').forEach(btn=>{
    btn.onclick=async ()=>{
      const u = allUsers[btn.dataset.username];
      const editModal = document.getElementById('editModal');
      if(u.type==='resident'){
        document.getElementById('editResidentFields').style.display='block';
        document.getElementById('editSecurityFields').style.display='none';
        document.getElementById('editApartment').value=u.username;
      } else {
        document.getElementById('editResidentFields').style.display='none';
        document.getElementById('editSecurityFields').style.display='block';
        document.getElementById('editFullName').value=u.fullName;
        document.getElementById('editPhone').value=u.phone;
      }
      document.getElementById('editPassword').value=u.password;
      editModal.style.display='flex';
      document.getElementById('saveEditBtn').onclick=async ()=>{
        const newPass = document.getElementById('editPassword').value.trim();
        const newPhone = u.type==='security'?document.getElementById('editPhone').value.trim():undefined;
        const updates = {password:newPass};
        if(newPhone) updates.phone=newPhone;
        await update(ref(db,'users/'+btn.dataset.username), updates);
        alert("Güncellendi!");
        editModal.style.display='none';
      };
      document.getElementById('closeEditBtn').onclick=()=>editModal.style.display='none';
    };
  });
}

// Mesaj Gönderme Özelliği ve Otomatik Satır Kırma
const sendMsgBtn = document.getElementById('sendMsgBtn');
const msgContent = document.getElementById('msgContent');
const msgType = document.getElementById('msgType');
const msgSubject = document.getElementById('msgSubject');
const progressBar = document.getElementById('progressBar');
const msgStatus = document.getElementById('msgStatus');

function formatMessage(text, maxCharsPerLine = 50){
  const words = text.split(' ');
  let line = '';
  let formatted = '';
  for(const word of words){
    if((line + word).length > maxCharsPerLine){
      formatted += line.trim() + '\n';
      line = word + ' ';
    } else { line += word + ' '; }
  }
  if(line) formatted += line.trim();
  return formatted;
}

sendMsgBtn.addEventListener('click', async ()=>{
  const subject = msgSubject.value.trim();
  const rawMsg = msgContent.value.trim();
  if(!subject){ alert("Konu boş olamaz!"); return; }
  if(!rawMsg){ alert("Mesaj boş olamaz!"); return; }

  const formattedMsg = formatMessage(rawMsg);

  sendMsgBtn.disabled = true;
  const originalBtnText = sendMsgBtn.textContent;
  sendMsgBtn.textContent = "Gönderiliyor...";

  const snapshot = await get(ref(db,'users'));
  const usersObj = snapshot.val() || {};
  const targetUsers = Object.values(usersObj).filter(u=>u.type===msgType.value);
  if(targetUsers.length===0){ 
    alert("Hedef kullanıcı yok!"); 
    sendMsgBtn.disabled = false;
    sendMsgBtn.textContent = originalBtnText;
    return; 
  }

  let sentCount = 0;
  progressBar.style.width='0%';
  progressBar.textContent=`0/${targetUsers.length}`;

  for(const u of targetUsers){
    const userKey = u.username;
    const userRef = ref(db, 'messages/' + userKey);
    const userMsgsSnap = await get(userRef);
    let userMsgs = userMsgsSnap.exists() ? Object.values(userMsgsSnap.val()) : [];

    if(userMsgs.length >= maxMsgsPerUser) { userMsgs.shift(); }

    const timestamp = Date.now();
    userMsgs.push({
      from: currentUser.username,
      subject: subject,
      content: formattedMsg,
      date: new Date().toISOString()
    });
    await set(userRef, userMsgs.reduce((acc, m, idx) => { acc[timestamp+idx] = m; return acc; }, {}));

    sentCount++;
    const percent = (sentCount / targetUsers.length) * 100;
    progressBar.style.transition = 'width 0.3s';
    progressBar.style.width = percent + '%';
    progressBar.textContent = `${sentCount}/${targetUsers.length}`;
    await new Promise(res=>setTimeout(res,50));
  }

  msgContent.value='';
  msgSubject.value='';
  msgStatus.textContent = "Mesaj gönderildi!";
  sendMsgBtn.disabled = false;
  sendMsgBtn.textContent = originalBtnText;
});

listUsers();
</script>

</body>
</html>

