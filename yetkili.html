<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yetkili Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {margin:0; font-family:'Roboto',sans-serif; background:#1f2a38; color:#e0e0e0; min-height:100vh; padding:30px; display:flex; justify-content:center;}
.panel-wrapper {width:95%; max-width:1400px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;}
.panel {background:#222f3e; border-radius:15px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.5);}
.panel h2 {margin-top:0; margin-bottom:15px; color:#ffcc00; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;}
input, select, textarea {width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#1a2b3a; color:#fff; text-transform:uppercase;}
input:focus, select:focus, textarea:focus {outline:none; box-shadow:0 0 10px #ffcc00;}
button {padding:10px 18px; border:none; border-radius:12px; font-weight:500; cursor:pointer; transition:0.3s; margin-top:8px;}
button:hover {opacity:0.85;}
#createUserBtn {background:#27ae60; color:#fff;}
.delete {background:#e74c3c; color:#fff; margin-right:5px;}
.edit {background:#9b59b6; color:#fff;}
table {width:100%; border-collapse:collapse; margin-top:10px;}
th, td {padding:12px; text-align:left; background:#1a2b3a; border-bottom:1px solid rgba(255,255,255,0.15);}
th {background:#2c3e50; color:#ffcc00; text-transform:uppercase;}
tr:hover {background: rgba(52,152,219,0.2);}
header {grid-column: span 2; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;}
header h1 {color:#ffcc00; margin:0; font-size:2rem;}
header button {background:#e67e22; color:#fff; border-radius:12px; padding:8px 15px; margin-left:5px;}
.modal {display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center;}
.modal-content {background:#1f2a38; padding:20px; border-radius:12px; width:320px; display:flex; flex-direction:column; gap:10px;}
.modal-content input, .modal-content textarea {margin:0;}
.modal-content button {margin-top:10px;}
#profileBtn {background:#2980b9; color:#fff; border-radius:50%; width:40px; height:40px; font-size:18px;}
#searchInput {width:calc(100% - 90px); display:inline-block;}
#searchBtn {width:80px; display:inline-block; background:#3498db; color:#fff;}
.pagination {margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;}
.page-btn {background:#2980b9; color:#fff; border-radius:8px; padding:5px 10px; cursor:pointer;}
.page-btn.active {background:#ffcc00; color:#000;}
.password-info {margin-top:5px; color:#ffcc00; font-size:0.9rem;}
.progress-container {width:100%; background:#1a2b3a; border-radius:12px; height:25px; margin-top:10px; overflow:hidden;}
.progress-bar {height:100%; width:0%; background:#27ae60; display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold;}
#totalUsers {margin-bottom:10px; font-weight:bold; color:#ffcc00;}
@media (max-width: 768px){.panel-wrapper {grid-template-columns:1fr;}}
/* Mobil uyumluluk iÃ§in eklemeler */
@media (max-width: 1024px) {
  .panel-wrapper {
    grid-template-columns: 1fr;
    padding: 20px;
  }
  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  header div {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  #searchInput {
    width: 100%;
    margin-bottom: 8px;
  }
  #searchBtn {
    width: 100%;
  }
  .modal-content {
    width: 90%;
    max-width: 400px;
  }
  input, select, textarea, button {
    font-size: 1rem;
    padding: 12px;
  }
}

@media (max-width: 480px) {
  header h1 {
    font-size: 1.5rem;
  }
  button {
    padding: 10px;
    font-size: 0.9rem;
  }
  .progress-container {
    height: 20px;
  }
  .progress-bar {
    font-size: 0.8rem;
  }
}

</style>
</head>
<body>

<div class="panel-wrapper">

<header>
  <h1>Yetkili Paneli</h1>
  <div>
    <button id="profileBtn">ðŸ‘¤</button>
    <button id="olayBtn">Olay Bildirimleri</button>
    <button id="patrolBtn">Devriye Takip</button>
    <button id="watchBtn" onclick="window.location.href='tamam.html'">NÃ¶bet Takip</button>
    <button id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
</header>



<!-- Yeni KullanÄ±cÄ± OluÅŸtur Paneli -->
<div class="panel">
<h2>Yeni KullanÄ±cÄ± OluÅŸtur</h2>
<select id="newType">
  <option value="resident">Site Sakini</option>
  <option value="security">GÃ¼venlik</option>
</select>

<div id="residentFields">
  <select id="newBlock"></select>
  <input type="text" id="newApartment" placeholder="Daire NumarasÄ±">
</div>

<div id="securityFields" style="display:none;">
  <input type="text" id="newFullName" placeholder="Ad Soyad">
  <input type="text" id="newPhone" placeholder="Telefon NumarasÄ±">
</div>

<input type="password" id="newPassword" placeholder="Åžifre" readonly>
<div class="password-info" id="passwordInfo"></div>
<button id="createUserBtn">OluÅŸtur</button>
<div id="createMsg"></div>
</div>

<!-- Mesaj GÃ¶nder Paneli -->
<div class="panel">
<h2>Mesaj GÃ¶nder</h2>
<label for="msgType">Mesaj GÃ¶nderilecek Tip</label>
<select id="msgType">
  <option value="resident">Site Sakini</option>
  <option value="security">GÃ¼venlik</option>
</select>

<label for="msgSubject">Konu</label>
<input type="text" id="msgSubject" placeholder="Mesaj konusu...">

<label for="msgContent">Mesaj</label>
<textarea id="msgContent" rows="4" placeholder="MesajÄ±nÄ±zÄ± buraya yazÄ±n..."></textarea>

<button id="sendMsgBtn" style="background:#2980b9; color:#fff;">GÃ¶nder</button>
<div class="progress-container">
  <div class="progress-bar" id="progressBar">0/0</div>
</div>
<div id="msgStatus" style="margin-top:5px; color:#ffcc00;"></div>
</div>

<!-- KullanÄ±cÄ± Tablosu Paneli -->
<div class="panel" style="grid-column: span 2;">
<h2>KullanÄ±cÄ±lar</h2>
<div id="totalUsers"></div>
<div>
<input type="text" id="searchInput" placeholder="Ara...">
<button id="searchBtn">Ara</button>
</div>
<table>
<thead>
<tr><th>Daire / Ad Soyad</th><th>Blok / Telefon</th><th>Tip</th><th>Åžifre</th><th>Ä°ÅŸlem</th></tr>
</thead>
<tbody id="usersTable"></tbody>
</table>
<div class="pagination" id="pagination"></div>
</div>

<!-- Modallar: DÃ¼zenleme ve Profil -->
<div id="editModal" class="modal">
<div class="modal-content">
<h3>DÃ¼zenle</h3>
<div id="editResidentFields">
<label>Daire NumarasÄ±</label>
<input type="text" id="editApartment" disabled>
</div>
<div id="editSecurityFields" style="display:none;">
<label>Ad Soyad</label>
<input type="text" id="editFullName" disabled>
<label>Telefon</label>
<input type="text" id="editPhone">
</div>
<label>Åžifre</label>
<input type="text" id="editPassword">
<button id="saveEditBtn">Kaydet</button>
<button id="closeEditBtn">Kapat</button>
</div>
</div>

<div id="profileModal" class="modal">
<div class="modal-content">
<h3>Profil</h3>
<label>KullanÄ±cÄ± AdÄ±</label>
<input type="text" id="profileUsername" disabled>
<label>Eski Åžifre</label>
<input type="password" id="oldProfilePassword" placeholder="Eski ÅŸifre">
<label>Yeni Åžifre</label>
<input type="password" id="profilePassword" placeholder="Yeni ÅŸifre">
<button id="saveProfileBtn">GÃ¼ncelle</button>
<button id="closeProfileBtn" style="background:#c0392b;">Kapat</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const maxMsgsPerUser = 5;

// Yetki kontrolÃ¼
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=="admin"){
  alert("Yetkisiz eriÅŸim!");
  window.location.href="index.html";
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', ()=>{ sessionStorage.removeItem('currentUser'); window.location.href='index.html'; });
document.getElementById('patrolBtn').addEventListener('click', ()=>{ window.location.href = 'takip.html'; });
document.getElementById('olayBtn').addEventListener('click', () => {
    window.location.href = 'olaylar.html'; // adminin olaylarÄ± gÃ¶receÄŸi sayfa
});


// Profil modal
const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('profileModal');
const profileUsername = document.getElementById('profileUsername');
const oldProfilePassword = document.getElementById('oldProfilePassword');
const profilePassword = document.getElementById('profilePassword');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const closeProfileBtn = document.getElementById('closeProfileBtn');

profileBtn.addEventListener('click', ()=>{ profileUsername.value=currentUser.username; oldProfilePassword.value=""; profilePassword.value=""; profileModal.style.display="flex"; });
closeProfileBtn.addEventListener('click', ()=>profileModal.style.display="none");
saveProfileBtn.addEventListener('click', async ()=>{ 
  const oldPass = oldProfilePassword.value.trim();
  const newPass = profilePassword.value.trim();
  if(!oldPass||!newPass){ alert("Alanlar boÅŸ olamaz!"); return; }
  const snapshot = await get(ref(db,'users/'+currentUser.username));
  if(snapshot.exists() && snapshot.val().password === oldPass){
    await update(ref(db,'users/'+currentUser.username), {password:newPass});
    alert("Åžifre gÃ¼ncellendi!");
    profileModal.style.display="none";
  } else { alert("Eski ÅŸifre yanlÄ±ÅŸ!"); }
});

// Form alanlarÄ± ve ÅŸifre otomatik
const newType = document.getElementById('newType');
const residentFields = document.getElementById('residentFields');
const securityFields = document.getElementById('securityFields');
const newPassword = document.getElementById('newPassword');
const passwordInfo = document.getElementById('passwordInfo');

for(let c=65;c<=90;c++){document.getElementById('newBlock').innerHTML += `<option value="${String.fromCharCode(c)}">${String.fromCharCode(c)}</option>`;}

function updatePasswordField(){
  if(newType.value==='resident'){
    const block = document.getElementById('newBlock').value;
    const apartment = document.getElementById('newApartment').value.trim();
    const pwd = block && apartment ? (block+apartment) : '';
    newPassword.value = pwd;
    passwordInfo.textContent = pwd ? `Åžifre otomatik atandÄ± Åžifreniz => ${pwd} <= Bu ÅŸifreyi profilinizden deÄŸiÅŸtirebilirsiniz` : '';
  } else {
    const fullName = document.getElementById('newFullName').value.trim().toUpperCase();
    const pwd = fullName;
    newPassword.value = pwd;
    passwordInfo.textContent = pwd ? `Åžifre otomatik atandÄ± Åžifreniz => ${pwd} <= Bu ÅŸifreyi profilinizden deÄŸiÅŸtirebilirsiniz` : '';
  }
}

newType.addEventListener('change', ()=>{ 
  if(newType.value==='resident'){ residentFields.style.display='block'; securityFields.style.display='none'; } 
  else { residentFields.style.display='none'; securityFields.style.display='block'; } 
  updatePasswordField(); 
});

document.getElementById('newBlock').addEventListener('input', updatePasswordField);
document.getElementById('newApartment').addEventListener('input', updatePasswordField);
document.getElementById('newFullName').addEventListener('input', e=>{ e.target.value=e.target.value.toUpperCase(); updatePasswordField(); });

// KullanÄ±cÄ± listeleme
const usersTable = document.getElementById('usersTable');
const paginationDiv = document.getElementById('pagination');
const totalUsersDiv = document.getElementById('totalUsers');
let allUsers = {};
let filteredUsers = [];
let currentPage = 1;
const pageSize = 20;

function listUsers(){
  const usersRef = ref(db,'users');
  onValue(usersRef, snapshot=>{
    const val = snapshot.val() || {};
    allUsers = val;
    applyFilter();
  });
}

function applyFilter(){
  const searchVal = document.getElementById('searchInput').value.toLowerCase();
  filteredUsers = Object.values(allUsers).filter(u=>{
    if(u.type!=='resident' && u.type!=='security') return false;
    if(searchVal==='') return true;
    if(u.type==='resident'){
      const code = (u.block+u.username).toLowerCase();
      return code.includes(searchVal);
    } else {
      return (u.fullName && u.fullName.toLowerCase().includes(searchVal)) || (u.phone && u.phone.includes(searchVal));
    }
  });
  currentPage = 1;
  renderTable();
}

function renderTable(){
  usersTable.innerHTML='';
  totalUsersDiv.textContent = `Toplam KullanÄ±cÄ±: ${filteredUsers.length}`;
  const start = (currentPage-1)*pageSize;
  const end = start + pageSize;
  const pageUsers = filteredUsers.slice(start,end);
  pageUsers.forEach(u=>{
    const tr = document.createElement('tr');
    const nameCol = u.type==='resident' ? u.username : u.fullName;
    const blockCol = u.type==='resident' ? u.block : u.phone;
    const typeCol = u.type==='resident' ? "Site Sakini" : "GÃ¼venlik";
    tr.innerHTML = `<td>${nameCol}</td><td>${blockCol}</td><td>${typeCol}</td><td>${u.password}</td>
                    <td><button class="edit" data-username="${u.username}">DÃ¼zenle</button>
                    <button class="delete" data-username="${u.username}">Sil</button></td>`;
    usersTable.appendChild(tr);
  });
  renderPagination();
  attachRowEvents();
}

function renderPagination(){
  paginationDiv.innerHTML='';
  const totalPages = Math.ceil(filteredUsers.length/pageSize);
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.className='page-btn'+(i===currentPage?' active':'');
    btn.textContent=i;
    btn.onclick=()=>{ currentPage=i; renderTable(); };
    paginationDiv.appendChild(btn);
  }
}

document.getElementById('searchBtn').addEventListener('click', applyFilter);
document.getElementById('searchInput').addEventListener('keyup', e=>{ if(e.key==='Enter') applyFilter(); });

// Yeni kullanÄ±cÄ± oluÅŸtur
document.getElementById('createUserBtn').addEventListener('click', async ()=>{
  const type = newType.value;
  let data = {};
  if(type==='resident'){
    const block = document.getElementById('newBlock').value;
    const apartment = document.getElementById('newApartment').value.trim();
    if(!apartment){ alert("Daire numarasÄ± gerekli!"); return; }
    const username = block+apartment;
    const password = username;
    data = {username, password, type, block};
    await set(ref(db,'users/'+username), data);
  } else {
    const fullName = document.getElementById('newFullName').value.trim().toUpperCase();
    const phone = document.getElementById('newPhone').value.trim();
    if(!fullName||!phone){ alert("Alanlar boÅŸ olamaz!"); return; }
    const password = fullName;
    data = {username:fullName, password, type, fullName, phone};
    await set(ref(db,'users/'+fullName), data);
  }
  alert("KullanÄ±cÄ± oluÅŸturuldu!");
});

// DÃ¼zenle ve silme iÅŸlemleri
function attachRowEvents(){
  document.querySelectorAll('.delete').forEach(btn=>{
    btn.onclick = async ()=>{
      if(confirm("Silmek istediÄŸinize emin misiniz?")){
        await remove(ref(db,'users/'+btn.dataset.username));
      }
    };
  });
  document.querySelectorAll('.edit').forEach(btn=>{
    btn.onclick=async ()=>{
      const u = allUsers[btn.dataset.username];
      const editModal = document.getElementById('editModal');
      if(u.type==='resident'){
        document.getElementById('editResidentFields').style.display='block';
        document.getElementById('editSecurityFields').style.display='none';
        document.getElementById('editApartment').value=u.username;
      } else {
        document.getElementById('editResidentFields').style.display='none';
        document.getElementById('editSecurityFields').style.display='block';
        document.getElementById('editFullName').value=u.fullName;
        document.getElementById('editPhone').value=u.phone;
      }
      document.getElementById('editPassword').value=u.password;
      editModal.style.display='flex';
      document.getElementById('saveEditBtn').onclick=async ()=>{
        const newPass = document.getElementById('editPassword').value.trim();
        const newPhone = u.type==='security'?document.getElementById('editPhone').value.trim():undefined;
        const updates = {password:newPass};
        if(newPhone) updates.phone=newPhone;
        await update(ref(db,'users/'+btn.dataset.username), updates);
        alert("GÃ¼ncellendi!");
        editModal.style.display='none';
      };
      document.getElementById('closeEditBtn').onclick=()=>editModal.style.display='none';
    };
  });
}

// Mesaj GÃ¶nderme Ã–zelliÄŸi ve Otomatik SatÄ±r KÄ±rma
const sendMsgBtn = document.getElementById('sendMsgBtn');
const msgContent = document.getElementById('msgContent');
const msgType = document.getElementById('msgType');
const msgSubject = document.getElementById('msgSubject');
const progressBar = document.getElementById('progressBar');
const msgStatus = document.getElementById('msgStatus');

function formatMessage(text, maxCharsPerLine = 50){
  const words = text.split(' ');
  let line = '';
  let formatted = '';
  for(const word of words){
    if((line + word).length > maxCharsPerLine){
      formatted += line.trim() + '\n';
      line = word + ' ';
    } else {
      line += word + ' ';
    }
  }
  if(line) formatted += line.trim();
  return formatted;
}

sendMsgBtn.addEventListener('click', async ()=>{
  const subject = msgSubject.value.trim();
  const rawMsg = msgContent.value.trim();
  if(!subject){ alert("Konu boÅŸ olamaz!"); return; }
  if(!rawMsg){ alert("Mesaj boÅŸ olamaz!"); return; }

  const formattedMsg = formatMessage(rawMsg);

  sendMsgBtn.disabled = true;
  const originalBtnText = sendMsgBtn.textContent;
  sendMsgBtn.textContent = "GÃ¶nderiliyor...";

  const snapshot = await get(ref(db,'users'));
  const usersObj = snapshot.val() || {};
  const targetUsers = Object.values(usersObj).filter(u=>u.type===msgType.value);
  if(targetUsers.length===0){ 
    alert("Hedef kullanÄ±cÄ± yok!"); 
    sendMsgBtn.disabled = false;
    sendMsgBtn.textContent = originalBtnText;
    return; 
  }

  let sentCount = 0;
  progressBar.style.width='0%';
  progressBar.textContent=`0/${targetUsers.length}`;

  for(const u of targetUsers){
    const userKey = u.username;
    const userRef = ref(db, 'messages/' + userKey);
    const userMsgsSnap = await get(userRef);
    let userMsgs = userMsgsSnap.exists() ? Object.values(userMsgsSnap.val()) : [];

    if(userMsgs.length >= maxMsgsPerUser) { userMsgs.shift(); }

    const timestamp = Date.now();
    userMsgs.push({
      from: currentUser.username,
      subject: subject,
      content: formattedMsg,
      date: new Date().toISOString()
    });
    await set(userRef, userMsgs.reduce((acc, m, idx) => { acc[timestamp+idx] = m; return acc; }, {}));

    sentCount++;
    const percent = (sentCount / targetUsers.length) * 100;
    progressBar.style.transition = 'width 0.3s';
    progressBar.style.width = percent + '%';
    progressBar.textContent = `${sentCount}/${targetUsers.length}`;
    await new Promise(res=>setTimeout(res,50));
  }

  msgContent.value='';
  msgSubject.value='';
  msgStatus.textContent = "Mesaj gÃ¶nderildi!";
  sendMsgBtn.disabled = false;
  sendMsgBtn.textContent = originalBtnText;
});

// BaÅŸlangÄ±Ã§ta kullanÄ±cÄ±larÄ± listele
listUsers();
</script>

</body>
</html>
